import{D,g as y,a as C}from"./index.js";import{bG as x,i as z,j as V,A as W,ay as Y,a1 as H,aM as j,aK as $,bD as X,aV as K,bo as J,bk as q,bm as Q,ag as Z,_ as ee,at as ae,l as te,k as ie,aI as se,b as re,aU as ne,bn as oe,bz as ce,ae as de,X as le,Y as me,br as Ee,Z as fe,c as ge,bA as pe,by as Se,bR as Te,aX as be,bI as ue,bq as he,b7 as Ae,b1 as _e,b2 as Re,bK as Fe,bJ as De,bu as ye,E as Ce,aJ as Ie,F as Pe,as as Oe,av as Ue,bL as Le,bs as we,I as Be,ac as Me,a5 as ke,a_ as ve,M as Ne,B as Ge,ah as xe,ax as ze,N as Ve,bU as We,bH as Ye,y as He,z as je,an as $e,bS as Xe,bB as Ke,aY as Je,P as qe,aO as Qe,al as Ze,p as ea,e as aa,S as ta,a9 as ia,a8 as sa,m as ra,b8 as na,t as oa,u as ca,r as da,bx as la,aS as ma,aR as Ea,be as fa,aa as ga,bv as pa,n as Sa,bd as Ta,bE as ba,b5 as ua,b3 as ha,bf as Aa,$ as _a,az as Ra,V as Fa,T as Da,Q as ya,J as Ca,W as Ia,a4 as Pa,bl as Oa,bO as Ua,aq as La,ar as wa,af as Ba,aG as Ma,bW as ka,K as va,aF as Na,q as Ga,aH as xa,o as za,a0 as Va,ap as Wa,h as Ya,bX as Ha,d as ja,aC as $a,aD as Xa,c0 as Ka,bc as Ja,b$ as qa,ba as Qa,bP as Za,bQ as et,f as at,bj as tt,aN as it,aL as st,a6 as rt,bF as nt,aW as ot,bp as ct,ak as dt,a7 as lt,bZ as mt,au as Et,bY as ft,x as gt,bM as pt,L as St,a$ as Tt,C as bt,ai as ut,ao as ht,bT as At,bV as _t,bC as Rt,aZ as Ft,aP as Dt,am as yt,aT as Ct,ab as It,bg as Pt,aA as Ot,U as Ut,R as Lt,H as wt,bt as Bt,w as Mt,aw as kt,b0 as vt,G as Nt,aQ as Gt,bh as xt,a3 as zt,O as Vt,v as Wt,aj as Yt,ad as Ht,aB as jt,bb as $t,b9 as Xt,bi as Kt,c1 as Jt,bN as qt,b_ as Qt,s as Zt,a2 as ei,aE as ai,c2 as ti,bw as ii,b6 as si,b4 as ri}from"./index.js";import{T as oi,a as ci,W as di,i as li,d as mi,c as Ei,b as fi,k as gi,l as pi,j as Si,e as Ti,g as bi,f as ui,h as hi,t as Ai}from"./webgpu-renderer-impl.js";import{Canvas2DFallbackRenderer as Ri}from"./canvas2d-fallback-renderer.js";import"./react.js";import"./zustand.js";import"./radix.js";import"./three.js";const R=4;async function*v(s,n={}){const e={...D,...n,audioSettings:{...D.audioSettings,...n.audioSettings}};e.codec==="prores"&&(e.codec="h264",e.format="mp4",e.bitrate=25e3,e.quality=95);const{timeline:f}=s,m=y(),p=P(f);if(p<=0)return{success:!1,error:{code:"MUXER_ERROR",message:"Timeline is empty. Add clips before exporting.",phase:"preparing",recoverable:!1}};const t=Math.ceil(p*e.frameRate);yield u("preparing",0,t);const d=m.isSimpleProject(s);if(d.simple&&d.singleClip){const i=s.mediaLibrary.items.find(a=>a.id===d.singleClip.mediaId);if(i?.blob){const a=s.timeline.tracks.flatMap(g=>g.clips).find(g=>g.mediaId===d.singleClip.mediaId),l=a&&(a.effects&&a.effects.length>0||a.transform&&(a.transform.scale.x!==1||a.transform.scale.y!==1||a.transform.rotation!==0||a.transform.position.x!==0||a.transform.position.y!==0||a.transform.opacity!==1)||a.keyframes&&a.keyframes.length>0),E=s.timeline.tracks.filter(g=>!g.hidden),r=E.length>1,S=E.some(g=>(g.type==="text"||g.type==="graphics")&&g.clips.length>0);if(!l&&!r&&!S){yield u("encoding",.1,t);const g={width:e.width,height:e.height,frameRate:e.frameRate,format:e.format==="webm"?"webm":"mp4",videoBitrate:`${e.bitrate}k`,audioBitrate:`${e.audioSettings.bitrate}k`,startTime:d.singleClip.startTime,endTime:d.singleClip.endTime,speed:d.singleClip.speed},_=new FormData;_.append("media",new File([i.blob],"input",{type:i.blob.type})),_.append("settings",JSON.stringify(g));const A=await fetch("/was/openreel_video/render_direct",{method:"POST",body:_});if(!A.ok)return{success:!1,error:{code:"FRAME_ENCODE_FAILED",message:(await A.json().catch(()=>({}))).error||`Backend render failed (HTTP ${A.status})`,phase:"encoding",recoverable:!1}};const F=await A.json();return yield u("complete",1,t),{success:!0,stats:{framesRendered:t,fileSize:F.size,duration:p,averageBitrate:0,averageSpeed:0},filename:F.filename}}}}const T=await fetch("/was/openreel_video/render_init",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({width:e.width,height:e.height,frameRate:e.frameRate,totalFrames:t,format:e.format==="webm"?"webm":"mp4",videoBitrate:`${e.bitrate}k`,audioBitrate:`${e.audioSettings.bitrate}k`})});if(!T.ok)return{success:!1,error:{code:"MUXER_ERROR",message:(await T.json().catch(()=>({}))).error||"Failed to initialize backend render session",phase:"preparing",recoverable:!1}};const{render_id:b}=await T.json();await m.initialize(),m.videoEngine?.resetExportState();const c=C();c.isAvailable()||await c.initialize(),c.clearFrameCache(),c.disposeAllExportDecoders();const o=new Set;for(const i of s.timeline.tracks)for(const a of i.clips)a.mediaId&&o.add(a.mediaId);for(const i of o){const a=s.mediaLibrary.items.find(l=>l.id===i);a?.blob&&a.type==="video"&&await c.createExportDecoder(i,a.blob,e.width)}try{let i=0;for(let r=0;r<t;r+=R){const S=[];for(let h=r;h<Math.min(r+R,t);h++)S.push(I(s,h,e,b));await Promise.all(S),i=Math.min(r+R,t),yield u("rendering",i/t*.7,t,i),i%60===0&&c.clearFrameCache()}yield u("encoding",.7,t,t);const a=await m.renderTimelineAudio(s,e);if(a&&a.length>0){const r=O(a);if(r.size>44){const S=new FormData;S.append("render_id",b),S.append("audio",new File([r],"audio.wav",{type:"audio/wav"})),await fetch("/was/openreel_video/render_audio",{method:"POST",body:S})}}yield u("encoding",.75,t,t);const l=await fetch("/was/openreel_video/render_finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({render_id:b})});if(!l.ok)return{success:!1,error:{code:"FRAME_ENCODE_FAILED",message:(await l.json().catch(()=>({}))).error||"Backend FFmpeg encoding failed",phase:"encoding",recoverable:!1}};const E=await l.json();return yield u("complete",1,t,t),{success:!0,stats:{framesRendered:t,fileSize:E.size,duration:p,averageBitrate:0,averageSpeed:0},filename:E.filename}}catch(i){return{success:!1,error:{code:"FRAME_ENCODE_FAILED",message:i instanceof Error?i.message:"Unknown error",phase:"rendering",recoverable:!1}}}finally{c.disposeAllExportDecoders(),c.clearFrameCache()}}async function I(s,n,e,f){const m=y(),p=n/e.frameRate,t=await m.videoEngine.renderFrame(s,p,e.width,e.height),d=new OffscreenCanvas(e.width,e.height),T=d.getContext("2d");T.fillStyle="#000000",T.fillRect(0,0,e.width,e.height),T.drawImage(t.image,0,0,e.width,e.height),t.image.close();const b=await d.convertToBlob({type:"image/jpeg",quality:.95}),c=new FormData;c.append("render_id",f),c.append("frame_index",String(n)),c.append("frame",new File([b],`frame_${String(n).padStart(6,"0")}.jpg`,{type:"image/jpeg"}));const o=await fetch("/was/openreel_video/render_frame",{method:"POST",body:c});if(!o.ok)throw new Error(`Frame upload failed for frame ${n}: HTTP ${o.status}`)}function u(s,n,e,f=0){return{phase:s,progress:n,currentFrame:f,totalFrames:e,estimatedTimeRemaining:0,bytesWritten:0,currentBitrate:0}}function P(s){let n=0;for(const e of s.tracks)for(const f of e.clips){const m=f.startTime+f.duration;m>n&&(n=m)}return n}function O(s){const n=s.numberOfChannels,e=s.sampleRate,f=16,m=f/8,p=n*m,t=e*p,d=s.length*p,b=44+d,c=new ArrayBuffer(b),o=new DataView(c),i=(l,E)=>{for(let r=0;r<E.length;r++)o.setUint8(l+r,E.charCodeAt(r))};i(0,"RIFF"),o.setUint32(4,b-8,!0),i(8,"WAVE"),i(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,n,!0),o.setUint32(24,e,!0),o.setUint32(28,t,!0),o.setUint16(32,p,!0),o.setUint16(34,f,!0),i(36,"data"),o.setUint32(40,d,!0);let a=44;for(let l=0;l<s.length;l++)for(let E=0;E<n;E++){const r=s.getChannelData(E)[l],S=Math.max(-32768,Math.min(32767,Math.round(r*32767)));o.setInt16(a,S,!0),a+=m}return new Blob([c],{type:"audio/wav"})}export{x as ASPECT_RATIO_PRESETS,z as ActionExecutor,V as ActionHistory,W as ActionValidator,Y as AdjustmentLayerEngine,H as AnimationEngine,j as AudioEffectsEngine,$ as AudioEngine,X as BUILTIN_TEMPLATES,K as BeatDetectionEngine,J as BeatSyncEngine,q as CAPTION_ANIMATION_STYLES,Ri as Canvas2DFallbackRenderer,Q as CharacterAnimator,Z as ChromaKeyEngine,ee as ColorGradingEngine,ae as CompositeFrameBuffer,te as DB_NAME,ie as DB_VERSION,se as DEFAULT_AUDIO_CONFIG,re as DEFAULT_AUDIO_SETTINGS,ne as DEFAULT_BEAT_DETECTION_CONFIG,oe as DEFAULT_BEAT_SYNC_CONFIG,ce as DEFAULT_BLEND_MODE,de as DEFAULT_CHROMA_KEY_SETTINGS,le as DEFAULT_COLOR_WHEELS,me as DEFAULT_CURVES,Ee as DEFAULT_GRAPHIC_TRANSFORM,fe as DEFAULT_HSL,ge as DEFAULT_IMAGE_SETTINGS,pe as DEFAULT_LAYER_OPACITY,Se as DEFAULT_LAYER_TRANSFORM,Te as DEFAULT_PARTICLE_CONFIG,be as DEFAULT_PLAYBACK_CONFIG,ue as DEFAULT_REFRAME_SETTINGS,he as DEFAULT_SHAPE_STYLE,Ae as DEFAULT_SUBTITLE_STYLE,_e as DEFAULT_TEXT_STYLE,Re as DEFAULT_TEXT_TRANSFORM,D as DEFAULT_VIDEO_SETTINGS,Fe as EASING_CATEGORIES,De as EASING_FUNCTIONS,ye as EMOJI_CATEGORIES,Ce as ExportEngine,Ie as FFT,Pe as FFmpegFallback,Oe as FrameRingBuffer,Ue as GPUCompositor,Le as GSAPAnimationEngine,we as GraphicsEngine,Be as InverseActionGenerator,Me as KeyframeEngine,ke as MaskEngine,ve as MasterTimelineClock,Ne as MediaBunnyEngine,Ge as MediaImportService,xe as MotionTrackingEngine,ze as MultiCamEngine,Ve as NestedSequenceEngine,We as PARTICLE_PRESETS,Ye as PLATFORM_PRESETS,He as PROXY_PRESETS,je as PROXY_THRESHOLDS,$e as ParallelFrameDecoder,Xe as ParticleEngine,Ke as PhotoEngine,Je as PlaybackController,qe as ProjectSerializer,Qe as RealtimeAudioGraph,Ze as RendererFactory,ea as SCHEMA_VERSION,aa as SOCIAL_MEDIA_CATEGORY_INFO,ta as SOCIAL_MEDIA_PRESETS,ia as SPEED_MAX,sa as SPEED_MIN,ra as STORES,na as SUBTITLE_STYLE_PRESETS,oa as SUPPORTED_AUDIO_FORMATS,ca as SUPPORTED_IMAGE_FORMATS,da as SUPPORTED_VIDEO_FORMATS,la as SVG_ANIMATION_PRESETS,ma as SoundGenerator,Ea as SoundLibraryEngine,fa as SpeechToTextEngine,ga as SpeedEngine,pa as StickerLibrary,Sa as StorageEngine,Ta as SubtitleEngine,ba as TemplateEngine,ua as TextAnimationEngine,oi as TextureCache,ha as TitleEngine,Aa as TranscriptionService,_a as TransitionEngine,Ra as UpscalingEngine,Fa as VIDEO_QUALITY_PRESETS,Da as VideoEffectsEngine,ya as VideoEngine,Ca as WAVEFORM_RESOLUTIONS,Ia as WaveformGenerator,ci as WebGPUEffectsProcessor,di as WebGPURenderer,Pa as applyEasing,li as blurComputeShaderSource,mi as borderRadiusShaderSource,Ei as calculateTextureSize,Oa as calculateUnitAnimationState,Ua as catmullRomInterpolate,fi as compositeShaderSource,gi as createBlurUniformsBuffer,La as createDecodeWorkerBlob,wa as createDecodeWorkerUrl,Ba as createDefaultChromaKeySettings,pi as createDimensionsBuffer,Ma as createEdgeDimensionsBuffer,ka as createEffectFromPreset,Si as createEffectUniformsBuffer,va as createGifFrameCache,Na as createLanczosDimensionsBuffer,Ti as createLayerUniformsBuffer,Ga as createProjectSerializer,xa as createSharpenUniformsBuffer,za as createStorageEngine,bi as createTransformMatrix,ui as createTransformUniformsBuffer,Va as createTransitionEngine,Wa as decodeWorkerCode,Ya as deserializeProject,Ha as detectDeviceCapabilities,ja as downloadBlob,$a as edgeDetectShaderSource,Xa as edgeDirectedShaderSource,hi as effectsComputeShaderSource,Ka as estimateExportTime,Ja as exportSRT,v as exportVideoWithBackendFFmpeg,qa as formatDeviceSummary,Qa as formatSRTTimestamp,Za as generateBezierPath,et as generateDefaultControlPoints,at as generateId,tt as getAnimationStyleDisplayName,it as getAudioEffectsEngine,st as getAudioEngine,rt as getAvailableBlendModes,nt as getBackgroundRemovalEngine,ot as getBeatDetectionEngine,ct as getBeatSyncEngine,dt as getBestRendererType,lt as getBlendModeName,mt as getCodecRecommendations,Et as getCompositeFrameBuffer,ft as getDeviceProfile,y as getExportEngine,gt as getFFmpegFallback,pt as getGSAPEngine,St as getGifFrameAtTime,Tt as getMasterClock,C as getMediaEngine,bt as getMediaImportService,ut as getMotionTrackingEngine,ht as getParallelFrameDecoder,At as getParticleEngine,_t as getParticlePresetById,Rt as getPhotoEngine,Ft as getPlaybackController,Dt as getRealtimeAudioGraph,yt as getRendererFactory,Ct as getSoundGenerator,It as getSpeedEngine,Pt as getTranscriptionService,Ot as getUpscalingEngine,Ut as getVideoEffectsEngine,Lt as getVideoEngine,wt as getWaveformGenerator,Bt as graphicsEngine,Mt as inferMediaType,kt as initializeGPUCompositor,vt as initializeMasterClock,Nt as initializeMediaImportService,Gt as initializeRealtimeAudioGraph,xt as initializeTranscriptionService,zt as interpolatePaths,Vt as isAnimatedGif,Wt as isSupportedFormat,Yt as isWebGPUSupported,Ht as keyframeEngine,jt as lanczosShaderSource,$t as parseSRT,Xt as parseSRTTimestamp,Kt as renderAnimatedCaption,Jt as runBenchmark,qt as sampleMotionPath,Qt as saveBenchmarkResult,Zt as serializeProject,ei as shapeToPath,ai as sharpenShaderSource,ti as shouldRecommendBenchmark,ii as stickerLibrary,si as textAnimationEngine,ri as titleEngine,Ai as transformShaderSource};

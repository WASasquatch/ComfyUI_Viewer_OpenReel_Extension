let d=null,i=null,n=null,c=null,h=null,u=!1,M=!1;const l=[];let S=!1;async function I(e,t,a){try{d=await import("./index-C12Q1mYS.js");const{Output:r,BufferTarget:s,StreamTarget:o,Mp4OutputFormat:p,WebMOutputFormat:w,MovOutputFormat:y,VideoSampleSource:F,AudioSampleSource:A,getFirstEncodableVideoCodec:T,getFirstEncodableAudioCodec:E,QUALITY_MEDIUM:z}=d;M=a||!1;let f;switch(e.format){case"webm":f=new w;break;case"mov":f=new y;break;case"mp4":default:f=new p({fastStart:a?!1:"in-memory"});break}if(M){const b=new WritableStream({write(m){const g=new Uint8Array(m.data);self.postMessage({type:"chunk",chunk:{data:g,position:m.position}},[g.buffer])}});h=new o(b,{chunked:!0,chunkSize:4*1024*1024})}else h=new s;i=new r({format:f,target:h});const v=await T(f.getSupportedVideoCodecs(),{width:e.width,height:e.height});if(!v)throw new Error("No supported video codec found");const C=f.getSupportedAudioCodecs();let k=await E(C);for(const b of["aac","mp3","opus"])if(!k){const m=C.find(g=>String(g).toLowerCase().includes(b)||b==="aac"&&String(g).toLowerCase().includes("mp4a"));if(m){k=m;break}}const x=e.width*e.height>1920*1080||a;n=new F({codec:v,bitrate:z,keyFrameInterval:e.keyframeInterval/e.frameRate,hardwareAcceleration:x?"prefer-software":"prefer-hardware"}),c=new A({codec:k||"aac",bitrate:e.audioSettings.bitrate*1e3}),i.addVideoTrack(n),i.addAudioTrack(c),i.setMetadataTags({title:t,date:new Date}),await i.start(),postMessage({type:"ready"})}catch(r){postMessage({type:"error",error:r instanceof Error?r.message:"Failed to initialize encoder"})}}async function B(){if(!(S||l.length===0)){for(S=!0;l.length>0&&!u;){const e=l.shift();await O(e)}S=!1}}async function O(e){if(u||!d||!n){e.frame.close();return}try{const{VideoSample:t}=d,a=new t(e.frame,{timestamp:e.timestamp,duration:1/e.frameRate});await n.add(a),a.close(),e.frame.close(),postMessage({type:"progress",progress:(e.frameIndex+1)/e.totalFrames,phase:"encoding",currentFrame:e.frameIndex+1,totalFrames:e.totalFrames}),postMessage({type:"frameProcessed"})}catch(t){e.frame.close(),postMessage({type:"error",error:t instanceof Error?t.message:"Failed to encode frame"})}}function V(e,t,a,r,s){l.push({frame:e,frameIndex:t,timestamp:a,totalFrames:r,frameRate:s}),B()}async function R(e){if(!(u||!d||!c))try{const{AudioSample:t}=d,r=new OfflineAudioContext(e.channels.length,e.length,e.sampleRate).createBuffer(e.channels.length,e.length,e.sampleRate);for(let o=0;o<e.channels.length;o++)r.getChannelData(o).set(e.channels[o]);const s=t.fromAudioBuffer(r,0);for(const o of s)await c.add(o),o.close()}catch(t){postMessage({type:"error",error:t instanceof Error?t.message:"Failed to encode audio"})}}async function L(){for(;l.length>0||S;)await new Promise(e=>setTimeout(e,50));if(u||!i||!n||!c||!h){postMessage({type:"error",error:"Encoder not initialized"});return}try{if(n.close(),c.close(),postMessage({type:"progress",progress:.98,phase:"muxing"}),await i.finalize(),M)postMessage({type:"complete",blob:void 0,progress:1,phase:"complete"});else{const t=h.buffer;if(!t)throw new Error("Output buffer is empty");const a=new Blob([t],{type:"video/mp4"});postMessage({type:"complete",blob:a,progress:1,phase:"complete"})}}catch(e){postMessage({type:"error",error:e instanceof Error?e.message:"Failed to finalize video"})}}function P(){u=!0;for(const e of l)e.frame.close();if(l.length=0,n)try{n.close()}catch{}if(c)try{c.close()}catch{}}self.onmessage=e=>{const{type:t,settings:a,frame:r,frameIndex:s,timestamp:o,totalFrames:p,audioBuffer:w,projectName:y,useStreamTarget:F}=e.data;switch(t){case"init":a&&y&&(u=!1,I(a,y,F));break;case"addFrame":r!==void 0&&s!==void 0&&o!==void 0&&p!==void 0&&a&&V(r,s,o,p,a.frameRate);break;case"addAudio":w&&R(w);break;case"finalize":L();break;case"cancel":P();break}};
